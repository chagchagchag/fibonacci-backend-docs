---
title: k8s 셋업 (로컬)
description: 'K8S Setup'
category: 'Setup'
position: 103
---

## Notice
다른 문서 작성하는게 더 급해서 잠시 미뤄뒀는데, 조만간 가급적 빠르게 이 문서를 정리하도록 하겠습니다.
<br>

## 설치 스크립트
로컬 환경에 kind 클러스터 설치를 `setup.sh` 파일 하나를 실행하는 것으로 가능하게 하는 방법입니다. 아래와 같은 명령을 실행합니다.

```bash
cd cluster
source setup.sh
```
<br>

아래에서부터는 Cluster 정의가 어떻게 되는지, ArgoCD가 NodePort 로 어떻게 접속하는지, API 가 어떤 Service 에 붙어서 이 Service 를 어떤 ingress 에서 처리하는지를 정의합니다.<br>
<br>

## Cluster 정의
이 부분은 Kind 에 대한 내용을 파악하는 것인데, 귀찮다면 건너뛰셔도 됩니다.<br>

`cluster.yml`
```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      - containerPort: 30009 # ArgoCD Node Port 를 위한 바인딩
        hostPort: 30009 # ArgoCD 접속시 호스트 PC에서도 30009 로 접속
        protocol: TCP
      - containerPort: 80 # nginx-ingress 가 인식하는 포트
        hostPort: 80 # API 접속시 호스트 PC 의 80 포트로 접속
        protocol: TCP
  - role: worker
# - role: worker
# - role: worker
```
<br>

Kind 클러스터는 실제로 구동될 때 하나의 Container 로 동작합니다. Kind 클러스터를 실행한 후 Docker Desktop 을 열어서 확인하면 실제 생성된 Kind 클러스터를 확인 가능합니다.

`extraPortMappings[i].containerPort`
- `Kind 클러스터 컨테이너` 입장에서 외부로 노출할 포트를 의미합니다. 즉 `containerPort` 라는 것은 `Kind 클러스터 컨테이너`의 Port 를 의미합니다.
<br>

`extraPortMappings[i].hostPort`
- 호스트 PC 즉, 개발 PC 내에서 Kind 클러스터로 접속 시에 사용할 Port 를 의미합니다.
<br>

`nodes[i].role` 
- control-plane, worker 등을 지정해줄 수 있습니다. 만약 Cluster 가 하나의 Container 로만 구성되게끔 하려면 worker 를 사용하지 않아도 됩니다.
- 경험상 단순한 백엔드 애플리케이션이나 Frontend 애플리케이션을 테스트할 때에는 worker 까지는 필요 없었고 control-plane 하나만으로도 충분히 테스트가 가능했습니다. 다만 ArgoCD 와 함께 구동 시에는 `worker` 가 적어도 1기 이상은 있어야 합니다.
- next.js, nuxt.js 의 경우에도 `worker` 1기 이상은 있어야 파드가 정상적으로 기동되었던 것으로 기억합니다. 요즘 프론트엔드 프레임워크가 옛날 처럼 단순하고 정적인 레벨을 넘어섰기에 리소스도 어느 정도 잡아먹는 듯 합니다.
<br>

## cluster 생성, cluster 내에 ingress-nginx 연동
클러스터는 아래와 같이 생성 가능합니다.
```bash
kind create cluster --name fibonacci-cluster --config=cluster.yml
```
<br>


이렇게 생성된 클러스터는 아래와 같이 조회 가능합니다.
```bash
kind get clusters
```
<br>


kind 클러스터가 외부와 통신이 가능하려면 Ingress 컨트롤러가 필요합니다. Ingress 컨트롤러 중 가장 대중적으로 알려진 ingress-nginx 를 kind 클러스터 내에 설치하는 명령어는 아래와 같습니다.
```bash
## ingress-nginx 를 설치합니다.
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml


## ingress-nginx 내의 pod 이 로딩 될때 까지 kubectl wait 을 수행합니다.
## 타임아웃은 90초로 주었습니다.
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=90s
```
<br>

여기까지의 명령어들은 소스코드 리포지터리 내의 `cluster/create-cluster.sh` 파일 내에 정의해두었고, 그 내용은 아래와 같습니다.
`cluster/create-cluster.sh`
```bash
echo ""
echo "=== create Cluster & Ingress-Nginx (Ingress Controller) ==="
echo "[create] cluster creating..."
kind create cluster --name fibonacci-cluster --config=cluster.yml

echo ""
echo "[create] create ingress-nginx"
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml

echo ""
echo "[wait] wait ingress-nginx standby"
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=90s
```
<br>

## 클러스터 내에 ArgoCD 설치

### nodeport 정의
... 

### argocd 설치
... 

